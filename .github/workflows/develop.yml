name: Dev - Test, Build, and Deploy urbind-query-mechanism
permissions:
  contents: read
  packages: write

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - "backend/**"
      - "frontend/**"
      - "k8s/**"
      - "backend/Dockerfile"
      - "frontend/Dockerfile"
      - ".github/workflows/develop.yml"
  pull_request:
    branches:
      - main
    paths:
      - "backend/**"
      - "frontend/**"
      - "k8s/**"
      - "backend/Dockerfile"
      - "frontend/Dockerfile"
      - ".github/workflows/develop.yml"
    types: [opened, synchronize, reopened]

concurrency:
  group: ${{ github.event.repository.name }}-main-${{ github.event_name }}-${{ github.event.pull_request.number || github.ref_name }}
  cancel-in-progress: true

jobs:
  test:
    name: Run tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Set up uv
        uses: astral-sh/setup-uv@v3

      - name: Cache uv
        uses: actions/cache@v4
        with:
          path: ~/.cache/uv
          key: ${{ runner.os }}-uv-${{ hashFiles('uv.lock') }}
          restore-keys: |
            ${{ runner.os }}-uv-

      - name: Install dependencies
        run: uv sync --frozen --group dev

      - name: Run pytest
        run: uv run pytest

  build_backend:
    name: Build backend image
    if: github.ref == 'refs/heads/main'
    needs: test
    runs-on: ubuntu-latest
    env:
      REGISTRY: ghcr.io
      REPOSITORY: open-earth-foundation/query_mechanism_urbind-backend
    outputs:
      backend_image: ${{ env.REGISTRY }}/${{ env.REPOSITORY }}:${{ steps.vars.outputs.commit_hash }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get Git commit hash
        id: vars
        run: echo "commit_hash=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Build and push backend image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./backend/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.REPOSITORY }}:${{ steps.vars.outputs.commit_hash }}
            ${{ env.REGISTRY }}/${{ env.REPOSITORY }}:dev
          labels: |
            org.opencontainers.image.source: https://github.com/${{ github.repository }}
            org.opencontainers.image.revision: ${{ github.sha }}

  build_frontend:
    name: Build frontend image
    if: github.ref == 'refs/heads/main'
    needs: test
    runs-on: ubuntu-latest
    env:
      REGISTRY: ghcr.io
      REPOSITORY: open-earth-foundation/query_mechanism_urbind-frontend
    outputs:
      frontend_image: ${{ env.REGISTRY }}/${{ env.REPOSITORY }}:${{ steps.vars.outputs.commit_hash }}
      frontend_api_base_url: ${{ steps.vars.outputs.frontend_api_base_url }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Resolve frontend API base URL and commit hash
        id: vars
        shell: bash
        run: |
          echo "commit_hash=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          API_BASE="${{ vars.FRONTEND_API_BASE_URL }}"
          if [ -z "$API_BASE" ]; then
            API_BASE="https://query-mechanism-urbind-api.openearth.dev"
          fi
          echo "frontend_api_base_url=$API_BASE" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          build-args: |
            NEXT_PUBLIC_API_BASE_URL=${{ steps.vars.outputs.frontend_api_base_url }}
          tags: |
            ${{ env.REGISTRY }}/${{ env.REPOSITORY }}:${{ steps.vars.outputs.commit_hash }}
            ${{ env.REGISTRY }}/${{ env.REPOSITORY }}:dev
          labels: |
            org.opencontainers.image.source: https://github.com/${{ github.repository }}
            org.opencontainers.image.revision: ${{ github.sha }}

  deploy:
    name: Deploy to EKS
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    needs:
      - build_backend
      - build_frontend
    env:
      AWS_REGION: ${{ vars.EKS_DEV_REGION != '' && vars.EKS_DEV_REGION || 'us-east-1' }}
      EKS_CLUSTER_NAME: ${{ secrets.EKS_DEV_NAME }}
      BACKEND_IMAGE: ${{ needs.build_backend.outputs.backend_image }}
      FRONTEND_IMAGE: ${{ needs.build_frontend.outputs.frontend_image }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_EKS_DEV_USER }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_EKS_DEV_USER }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Configure kubeconfig
        run: aws eks update-kubeconfig --name "${EKS_CLUSTER_NAME}" --region "${AWS_REGION}"

      - name: Create or update backend secret
        run: |
          kubectl -n default create secret generic urbind-query-mechanism-backend-secrets \
            --from-literal=OPENROUTER_API_KEY="${{ secrets.OPENROUTER_API_KEY }}" \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Apply Kubernetes manifests
        run: |
          kubectl -n default apply -f k8s/backend-configmap.yml
          kubectl -n default apply -f k8s/backend-pvc.yml
          kubectl -n default apply -f k8s/backend-deployment.yml
          kubectl -n default apply -f k8s/backend-service.yml
          kubectl -n default apply -f k8s/frontend-deployment.yml
          kubectl -n default apply -f k8s/frontend-service.yml

      - name: Update deployment images
        run: |
          kubectl -n default set image deployment/urbind-query-mechanism-backend backend="${BACKEND_IMAGE}"
          kubectl -n default set image deployment/urbind-query-mechanism-frontend frontend="${FRONTEND_IMAGE}"

      - name: Wait for rollout
        run: |
          kubectl -n default rollout status deployment/urbind-query-mechanism-backend
          kubectl -n default rollout status deployment/urbind-query-mechanism-frontend

      - name: Show deployment summary
        run: |
          kubectl -n default get deployments urbind-query-mechanism-backend urbind-query-mechanism-frontend
          kubectl -n default get services urbind-query-mechanism-backend-service urbind-query-mechanism-frontend-service
